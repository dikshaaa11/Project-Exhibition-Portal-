<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Exhibition Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        
        .login-section, .dashboard {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .role-selector {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .role-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .role-btn.active {
            background: #3498db;
            color: white;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .char-counter {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }
        
        .char-counter.exceeded {
            color: #e74c3c;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #27ae60;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .project-card, .application-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #3498db;
            transition: all 0.3s;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status-selected {
            background: #d4edda;
            color: #155724;
        }
        
        .hidden {
            display: none;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .actions {
            margin-bottom: 30px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 15px;
            background: #f8d7da;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            color: #155724;
            text-align: center;
            padding: 15px;
            background: #d4edda;
            border-radius: 8px;
            margin: 10px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }

        .rejection-comment {
            background: #f8d7da;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }

        .user-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #17a2b8;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Project Exhibition Portal</h1>
            <p>Connect Faculty and Students for Academic Projects</p>
        </div>

        <div id="loginSection" class="login-section">
            <h2>Login to Your Account</h2>
            <div id="loginMessage"></div>
            <div class="role-selector">
                <button class="role-btn active" data-role="student">Student</button>
                <button class="role-btn" data-role="faculty">Faculty</button>
                <button class="role-btn" data-role="admin">Admin</button>
            </div>
            <div class="form-group">
                <label id="loginIdLabel">Registration Number:</label>
                <input type="text" id="loginId" placeholder="Enter registration number">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn" onclick="initDemo()">Initialize Demo Data</button>
            
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <h4>Demo Accounts:</h4>
                <p><strong>Faculty:</strong> 123456 / CompDr.</p>
                <p><strong>Student:</strong> 24CSE12345 / 010100</p>
                <p><strong>Admin:</strong> admin123 / admin123</p>
            </div>
        </div>

        <div id="passwordModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closePasswordModal()">&times;</span>
                <h3>Change Password Required</h3>
                <p>For security, you must change your default password before proceeding.</p>
                <div id="passwordModalMessage"></div>
                <div class="form-group">
                    <label>Current Password:</label>
                    <input type="password" id="currentPassword" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label>New Password:</label>
                    <input type="password" id="newPassword" placeholder="Enter new password (min. 6 characters)">
                </div>
                <div class="form-group">
                    <label>Confirm New Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm new password">
                </div>
                <button class="btn btn-success" onclick="changePassword()">Change Password</button>
            </div>
        </div>

        <div id="studentDashboard" class="dashboard hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Student Dashboard</h2>
                <div>
                    <button class="btn btn-warning" onclick="showPasswordModal()">Change Password</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="studentAppsCount">0</div>
                    <div>My Applications</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="availableProjectsCount">0</div>
                    <div>Available Projects</div>
                </div>
            </div>

            <h3>Available Projects</h3>
            <div id="availableProjects"></div>

            <h3>My Applications</h3>
            <div id="myApplications"></div>
        </div>
<div id="facultyDashboard" class="dashboard hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Faculty Dashboard</h2>
                <div>
                    <button class="btn btn-warning" onclick="showPasswordModal()">Change Password</button>
                    <button class="btn btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="myProjectsCount">0</div>
                    <div>My Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approvedCount">0</div>
                    <div>Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingCount">0</div>
                    <div>Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="reviewCount">0</div>
                    <div>To Review</div>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="showNewProjectForm()">Propose Project</button>
                <button class="btn" onclick="loadReviewProjects()">Review Projects</button>
            </div>

            <div id="newProjectForm" class="hidden">
                <h3>Propose New Project</h3>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="projectTitle" placeholder="Project title">
                </div>
                <div class="form-group">
                    <label>Area of Research:</label>
                    <select id="projectAreaOfResearch">
                        <option value="Aerospace">Aerospace</option>
                        <option value="Artificial Intelligence & Machine Learning">Artificial Intelligence & Machine Learning</option>
                        <option value="Business Administration">Business Administration</option>
                        <option value="Computer Science">Computer Science</option>
                        <option value="Cyber Security & Digital Forensics">Cyber Security & Digital Forensics</option>
                        <option value="E-Commerce">E-Commerce</option>
                        <option value="Electronics & Communication">Electronics & Communication</option>
                        <option value="Electronics & Communication Engineering">Electronics & Communication Engineering</option>
                        <option value="Gaming">Gaming</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project Description (Max 500 words):</label>
                    <textarea id="projectAbstract" placeholder="Project description" rows="6" oninput="updateCharCount()"></textarea>
                    <div id="charCount" class="char-counter">0 / 500 words</div>
                </div>
                <div class="form-group">
                    <label>Timeline:</label>
                    <input type="text" id="projectTimeline" placeholder="e.g., 6 months">
                </div>
                <div class="form-group">
                    <label>Available Seats:</label>
                    <input type="number" id="projectSeats" min="1" placeholder="Number of students">
                </div>
                <button class="btn btn-success" onclick="createProject()">Submit for Review</button>
                <button class="btn" onclick="hideNewProjectForm()">Cancel</button>
            </div>

            <div id="reviewProjectsSection" class="hidden">
                <h3>Projects for Review</h3>
                <div id="reviewProjects"></div>
            </div>

            <h3>My Projects</h3>
            <div id="facultyProjects"></div>

            <h3>Student Applications</h3>
            <div id="facultyApplications"></div>
        </div>

        <div id="adminDashboard" class="dashboard hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2>Admin Dashboard</h2>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div>Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalFaculty">0</div>
                    <div>Total Faculty</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">0</div>
                    <div>Total Users</div>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="showCreateUserForm()">Create New User</button>
            </div>

            <div id="createUserForm" class="hidden">
                <h3>Create New User Account</h3>
                <div id="createUserMessage"></div>
                <div class="role-selector">
                    <button class="role-btn active" data-role="student" onclick="toggleUserRole('student')">Student</button>
                    <button class="role-btn" data-role="faculty" onclick="toggleUserRole('faculty')">Faculty</button>
                </div>
                
                <div class="two-column">
                    <div>
                        <div class="form-group">
                            <label id="createLoginIdLabel">Registration Number:</label>
                            <input type="text" id="createLoginId" placeholder="Enter registration number">
                            <small id="loginIdFormatHint">Format: YYBBBNNNNN (e.g., 24BCE10076)</small>
                        </div>
                        <div class="form-group">
                            <label>Full Name:</label>
                            <input type="text" id="createName" placeholder="Enter full name">
                        </div>
                    </div>
                    <div>
                        <div class="form-group" id="dateOfBirthGroup">
                            <label>Date of Birth:</label>
                            <input type="date" id="createDOB">
                        </div>
                        <div class="form-group hidden" id="areaOfResearchGroup">
                            <label>Area of Research:</label>
                            <select id="createAreaOfResearch">
                                <option value="" disabled selected>-- Select an Area --</option>
                                <option value="Aerospace">Aerospace</option>
                                <option value="Artificial Intelligence & Machine Learning">Artificial Intelligence & Machine Learning</option>
                                <option value="Business Administration">Business Administration</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Cyber Security & Digital Forensics">Cyber Security & Digital Forensics</option>
                                <option value="E-Commerce">E-Commerce</option>
                                <option value="Electronics & Communication">Electronics & Communication</option>
                                <option value="Electronics & Communication Engineering">Electronics & Communication Engineering</option>
                                <option value="Gaming">Gaming</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="createUser()">Create User</button>
                <button class="btn" onclick="hideCreateUserForm()">Cancel</button>
            </div>

            <h3>User Management</h3>
            <div id="usersList"></div>
        </div>

        <div id="rejectModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRejectModal()">&times;</span>
                <h3>Project Review - Provide Feedback</h3>
                <div id="rejectModalMessage"></div>
                <div class="form-group">
                    <label>Feedback Comment (Required - Max 500 words):</label>
                    <textarea id="rejectComment" placeholder="Please provide detailed feedback for improvement..." rows="6" oninput="updateRejectCharCount()"></textarea>
                    <div id="rejectCharCount" class="char-counter">0 / 500 words</div>
                </div>
                <button class="btn btn-danger" onclick="submitRejection()">Submit Review</button>
                <button class="btn" onclick="closeRejectModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let currentUser = null;
        let token = null;
        let currentProjectForReject = null;

        // Utility functions
        function showMessage(containerId, message, isError = false) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${message}</div>`;
                setTimeout(() => container.innerHTML = '', 5000);
            }
        }

        function countWords(text) {
            if (!text) return 0;
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        function updateCharCount() {
            const textarea = document.getElementById('projectAbstract');
            const counter = document.getElementById('charCount');
            const wordCount = countWords(textarea.value);
            counter.textContent = `${wordCount} / 500 words`;
            counter.classList.toggle('exceeded', wordCount > 500);
            textarea.style.borderColor = wordCount > 500 ? '#e74c3c' : '#e9ecef';
        }

        function updateRejectCharCount() {
            const textarea = document.getElementById('rejectComment');
            const counter = document.getElementById('rejectCharCount');
            const wordCount = countWords(textarea.value);
            counter.textContent = `${wordCount} / 500 words`;
            counter.classList.toggle('exceeded', wordCount > 500);
            textarea.style.borderColor = wordCount > 500 ? '#e74c3c' : '#e9ecef';
        }

        // API functions
        async function apiCall(endpoint, options = {}) {
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                },
                ...options
            };
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        // Modal Functions
        function showPasswordModal() { document.getElementById('passwordModal').style.display = 'block'; }
        function closePasswordModal() { document.getElementById('passwordModal').style.display = 'none'; }
        function showRejectModal(projectId) {
            currentProjectForReject = projectId;
            document.getElementById('rejectModal').style.display = 'block';
        }
        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
            document.getElementById('rejectComment').value = '';
            currentProjectForReject = null;
        }
        
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) return showMessage('passwordModalMessage', 'Please fill all fields', true);
            if (newPassword !== confirmPassword) return showMessage('passwordModalMessage', 'New passwords do not match', true);
            if (newPassword.length < 6) return showMessage('passwordModalMessage', 'New password must be at least 6 characters', true);

            try {
                await apiCall('/api/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                showMessage('passwordModalMessage', 'Password changed successfully!');
                currentUser.mustChangePassword = false;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                setTimeout(closePasswordModal, 2000);
            } catch (error) {
                showMessage('passwordModalMessage', error.message, true);
            }
        }

        async function submitRejection() {
            const comment = document.getElementById('rejectComment').value;
            if (!comment.trim() || countWords(comment) > 500) {
                return showMessage('rejectModalMessage', 'Comment is required and must not exceed 500 words.', true);
            }
            try {
                await apiCall(`/api/projects/${currentProjectForReject}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ comment })
                });
                showMessage('rejectModalMessage', 'Project reviewed with feedback');
                setTimeout(() => {
                    closeRejectModal();
                    loadReviewProjects();
                    loadFacultyDashboard();
                }, 2000);
            } catch (error) {
                showMessage('rejectModalMessage', error.message, true);
            }
        }

        // Initialize demo data
        async function initDemo() {
            try {
                showMessage('loginMessage', 'Initializing demo data...');
                await apiCall('/api/init-demo', { method: 'POST' });
                showMessage('loginMessage', 'Demo data initialized successfully!');
            } catch (error) {
                showMessage('loginMessage', error.message, true);
            }
        }

        // Authentication
        async function login() {
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('password').value;
            const role = document.querySelector('.role-btn.active').dataset.role;

            if (!loginId || !password) return showMessage('loginMessage', 'Please enter login credentials', true);

            if (role === 'student' && !/^\d{2}[A-Z]{3}\d{5}$/.test(loginId)) {
                return showMessage('loginMessage', 'Invalid format. Use YYBBBNNNNN.', true);
            }
            if (role === 'faculty' && !/^\d{6}$/.test(loginId)) {
                return showMessage('loginMessage', 'Invalid format. Use 6 digits.', true);
            }

            try {
                const response = await apiCall('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ loginId, password })
                });

                if (response.user.role !== role) {
                    return showMessage('loginMessage', `Access denied: You are a ${response.user.role}, not a ${role}`, true);
                }

                token = response.token;
                currentUser = response.user;
                localStorage.setItem('token', token);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById(role + 'Dashboard').classList.remove('hidden');

                if (currentUser.mustChangePassword && role !== 'admin') showPasswordModal();
                if (role === 'student') loadStudentDashboard();
                else if (role === 'faculty') loadFacultyDashboard();
                else if (role === 'admin') loadAdminDashboard();
            } catch (error) {
                showMessage('loginMessage', error.message, true);
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // Student Dashboard
        async function loadStudentDashboard() {
            try {
                const [projects, applications] = await Promise.all([
                    apiCall('/api/projects'),
                    apiCall('/api/applications/my')
                ]);
                document.getElementById('studentAppsCount').textContent = applications.length;
                document.getElementById('availableProjectsCount').textContent = projects.length;
                const projectsDiv = document.getElementById('availableProjects');
                projectsDiv.innerHTML = projects.length === 0 ? '<p>No approved projects available yet.</p>' : projects.map(p => {
                    const hasApplied = applications.some(app => app.project._id === p._id);
                    return `
                    <div class="project-card">
                        <h4>${p.title}</h4><p><strong>Faculty:</strong> ${p.faculty.name}</p>
                        <p><strong>Description:</strong> ${p.abstract}</p><p><strong>Timeline:</strong> ${p.timeline}</p>
                        <p><strong>Seats Available:</strong> ${p.seatsAvailable}/${p.seats}</p>
                        <div style="margin-top: 15px;">
                        ${hasApplied ? '<span class="status-badge status-pending">Applied</span>' :
                          (p.seatsAvailable > 0 ? `<button class="btn" onclick="applyToProject('${p._id}')">Apply</button>` :
                          '<span class="status-badge status-rejected">Full</span>')}
                        </div>
                    </div>`;
                }).join('');
                const appsDiv = document.getElementById('myApplications');
                appsDiv.innerHTML = applications.length === 0 ? "<p>You haven't applied to any projects yet.</p>" : applications.map(app => `
                    <div class="application-card">
                        <h4>${app.project ? app.project.title : 'Unknown Project'}</h4>
                        <p><strong>Status:</strong> <span class="status-badge status-${app.status}">${app.status}</span></p>
                        <p><strong>Applied:</strong> ${new Date(app.appliedAt).toLocaleDateString()}</p>
                    </div>`).join('');
            } catch (error) { console.error('Error loading student dashboard:', error); }
        }

        async function applyToProject(projectId) {
            try {
                await apiCall('/api/applications', { method: 'POST', body: JSON.stringify({ projectId }) });
                alert('Application submitted successfully!');
                loadStudentDashboard();
            } catch (error) { alert('Error: ' + error.message); }
        }

        // Faculty Dashboard
        async function loadFacultyDashboard() {
            try {
                const [projects, applications, reviewProjects] = await Promise.all([
                    apiCall('/api/projects/my'),
                    apiCall('/api/applications/faculty'),
                    apiCall('/api/projects/review')
                ]);

                document.getElementById('myProjectsCount').textContent = projects.length;
                document.getElementById('approvedCount').textContent = projects.filter(p => p.status === 'approved').length;
                document.getElementById('pendingCount').textContent = projects.filter(p => p.status === 'pending').length;
                document.getElementById('reviewCount').textContent = reviewProjects.length;
                
                // My Projects
                const projectsDiv = document.getElementById('facultyProjects');
                projectsDiv.innerHTML = projects.length === 0 ? '<p>No projects created yet.</p>' : projects.map(p => {
                    let commentsHTML = '';
                    if (p.rejectionComments && p.rejectionComments.length > 0) {
                        commentsHTML = `
                        <div style="margin-top: 15px;"><h5>Review Comments:</h5>
                            ${p.rejectionComments.map(c => `
                                <div class="rejection-comment">
                                    <strong>Reviewer:</strong> ${c.faculty.name}<br>
                                    <strong>Feedback:</strong> ${c.comment}<br>
                                    <small>Reviewed: ${new Date(c.reviewedAt).toLocaleDateString()}</small>
                                </div>`).join('')}
                        </div>`;
                    }
                    return `
                    <div class="project-card">
                        <h4>${p.title}</h4><p><strong>Status:</strong> <span class="status-badge status-${p.status}">${p.status}</span></p>
                        <p><strong>Description:</strong> ${p.abstract}</p>
                        <p><strong>Seats:</strong> ${p.seatsAvailable}/${p.seats}</p>
                        ${commentsHTML}
                    </div>`;
                }).join('');

                // Student Applications
                const appsDiv = document.getElementById('facultyApplications');
                appsDiv.innerHTML = applications.length === 0 ? '<p>No applications received yet.</p>' : applications.map(app => `
                    <div class="application-card">
                        <h4>Application for: ${app.project.title}</h4>
                        <p><strong>Student:</strong> ${app.student.name} (${app.student.loginId})</p>
                        <p><strong>Status:</strong> <span class="status-badge status-${app.status}">${app.status}</span></p>
                        ${app.status === 'pending' ? `
                            <div style="margin-top: 15px;">
                                <button class="btn btn-success" onclick="selectStudent('${app._id}')">Select</button>
                                <button class="btn btn-danger" onclick="rejectStudent('${app._id}')">Reject</button>
                            </div>` : ''}
                    </div>`).join('');
            } catch(e) { console.error(e) }
        }
        async function selectStudent(appId) {
            try { await apiCall(`/api/applications/${appId}/select`, { method: 'POST' }); alert('Student selected!'); loadFacultyDashboard(); }
            catch (error) { alert('Error: ' + error.message); }
        }
        async function rejectStudent(appId) {
            try { await apiCall(`/api/applications/${appId}/reject`, { method: 'POST' }); alert('Application rejected.'); loadFacultyDashboard(); }
            catch (error) { alert('Error: ' + error.message); }
        }
        function showNewProjectForm() {
            document.getElementById('newProjectForm').classList.remove('hidden');
            document.getElementById('reviewProjectsSection').classList.add('hidden');
        }
        function hideNewProjectForm() {
            document.getElementById('newProjectForm').classList.add('hidden');
            document.getElementById('projectTitle').value = '';
            document.getElementById('projectAbstract').value = '';
            document.getElementById('projectTimeline').value = '';
            document.getElementById('projectSeats').value = '';
            updateCharCount();
        }
        async function createProject() {
            const title = document.getElementById('projectTitle').value;
            const abstract = document.getElementById('projectAbstract').value;
            const timeline = document.getElementById('projectTimeline').value;
            const seats = parseInt(document.getElementById('projectSeats').value);

            if (!title || !abstract || !timeline || !seats) return alert('Please fill all fields');
            if (countWords(abstract) > 500) return alert('Description cannot exceed 500 words');

            try {
                await apiCall('/api/projects', {
                    method: 'POST',
                    body: JSON.stringify({ title, abstract, timeline, seats })
                });
                hideNewProjectForm();
                alert('Project submitted for review successfully!');
                loadFacultyDashboard();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        async function loadReviewProjects() {
            document.getElementById('newProjectForm').classList.add('hidden');
            document.getElementById('reviewProjectsSection').classList.remove('hidden');
            try {
                const projects = await apiCall('/api/projects/review');
                const projectsDiv = document.getElementById('reviewProjects');
                projectsDiv.innerHTML = projects.length === 0 ? '<p>No projects pending your review.</p>' : projects.map(p => `
                <div class="project-card">
                    <h4>${p.title}</h4>
                    <p><strong>Faculty:</strong> ${p.faculty.name}</p><p><strong>Description:</strong> ${p.abstract}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="approveProject('${p._id}')">Approve</button>
                        <button class="btn btn-danger" onclick="showRejectModal('${p._id}')">Provide Feedback</button>
                    </div>
                </div>`).join('');
            } catch (error) { console.error(error); }
        }
        async function approveProject(projectId) {
            try { await apiCall(`/api/projects/${projectId}/approve`, { method: 'POST' }); alert('Review submitted!'); loadReviewProjects(); loadFacultyDashboard(); }
            catch (error) { alert('Error: ' + error.message); }
        }

        // Admin Dashboard
        async function loadAdminDashboard() {
            try {
                const users = await apiCall('/api/admin/users');
                const students = users.filter(u => u.role === 'student');
                const faculty = users.filter(u => u.role === 'faculty');
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalFaculty').textContent = faculty.length;
                document.getElementById('totalUsers').textContent = users.length;
                const usersDiv = document.getElementById('usersList');
                usersDiv.innerHTML = users.length === 0 ? '<p>No users found.</p>' : users.map(user => `
                    <div class="user-card">
                        <h4>${user.name}</h4><p><strong>Login ID:</strong> ${user.loginId}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        ${user.areaOfResearch ? `<p><strong>Area of Research:</strong> ${user.areaOfResearch}</p>` : ''}
                        <div style="margin-top: 15px;">
                            <button class="btn btn-warning" onclick="resetUser('${user._id}')">Reset</button>
                            <button class="btn btn-danger" onclick="deleteUser('${user._id}')">Delete</button>
                        </div>
                    </div>`).join('');
            } catch (error) { console.error('Error loading admin dashboard:', error); }
        }

        function showCreateUserForm() { document.getElementById('createUserForm').classList.remove('hidden'); }
        function hideCreateUserForm() {
            document.getElementById('createUserForm').classList.add('hidden');
            document.getElementById('createLoginId').value = '';
            document.getElementById('createName').value = '';
            document.getElementById('createDOB').value = '';
            document.getElementById('createAreaOfResearch').value = '';
        }

        // CORRECTED: This function now properly handles the hint text
        function toggleUserRole(role) {
            document.querySelectorAll('#createUserForm .role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const isStudent = role === 'student';
            const loginIdLabel = document.getElementById('createLoginIdLabel');
            const loginIdInput = document.getElementById('createLoginId');
            const dobGroup = document.getElementById('dateOfBirthGroup');
            const researchGroup = document.getElementById('areaOfResearchGroup');
            const hintText = document.getElementById('loginIdFormatHint');

            if (isStudent) {
                loginIdLabel.textContent = 'Registration Number:';
                loginIdInput.placeholder = 'Enter registration number';
                dobGroup.classList.remove('hidden');
                researchGroup.classList.add('hidden');
                hintText.style.display = 'block'; // Show hint
            } else {
                loginIdLabel.textContent = 'Login ID:';
                loginIdInput.placeholder = 'Enter 6-digit login ID';
                dobGroup.classList.add('hidden');
                researchGroup.classList.remove('hidden');
                hintText.style.display = 'none'; // Hide hint
            }
        }

        async function createUser() {
            const role = document.querySelector('#createUserForm .role-btn.active').dataset.role;
            const loginId = document.getElementById('createLoginId').value.trim();
            const name = document.getElementById('createName').value;
            const dateOfBirth = document.getElementById('createDOB').value;
            const areaOfResearch = document.getElementById('createAreaOfResearch').value;

            if (!loginId || !name) return showMessage('createUserMessage', 'Please fill all required fields', true);
            if (role === 'student' && !dateOfBirth) return showMessage('createUserMessage', 'Date of birth is required for students', true);
            if (role === 'faculty' && !areaOfResearch) return showMessage('createUserMessage', 'Area of research is required for faculty', true);

            if (role === 'student' && !/^\d{2}[A-Z]{3}\d{5}$/.test(loginId)) {
                return showMessage('createUserMessage', 'Invalid format for Registration Number. Use YYBBBNNNNN.', true);
            }
            if (role === 'faculty' && !/^\d{6}$/.test(loginId)) {
                return showMessage('createUserMessage', 'Invalid format for Login ID. Use 6 digits only.', true);
            }

            try {
                const response = await apiCall('/api/admin/create-user', {
                    method: 'POST',
                    body: JSON.stringify({ loginId, name, role, areaOfResearch, dateOfBirth })
                });
                showMessage('createUserMessage', `User created! Default password: ${response.user.defaultPassword}`);
                setTimeout(() => { hideCreateUserForm(); loadAdminDashboard(); }, 4000);
            } catch (error) {
                showMessage('createUserMessage', error.message, true);
            }
        }

        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This cannot be undone.')) {
                try { await apiCall(`/api/admin/user/${userId}`, { method: 'DELETE' }); alert('User deleted.'); loadAdminDashboard(); }
                catch (error) { alert('Error: ' + error.message); }
            }
        }
        async function resetUser(userId) {
            if (confirm('Are you sure you want to reset this user? All their data will be cleared.')) {
                try { await apiCall(`/api/admin/reset-user/${userId}`, { method: 'POST' }); alert('User account reset.'); loadAdminDashboard(); }
                catch (error) { alert('Error: ' + error.message); }
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('#loginSection .role-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#loginSection .role-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const role = this.dataset.role;
                    document.getElementById('loginIdLabel').textContent = role === 'student' ? 'Registration Number:' : (role === 'faculty' ? 'Login ID:' : 'Admin ID:');
                    document.getElementById('loginId').placeholder = `Enter ${role} ID`;
                });
            });

            // Check if user is already logged in
            const storedToken = localStorage.getItem('token');
            const storedUser = localStorage.getItem('currentUser');
            if (storedToken && storedUser) {
                token = storedToken;
                currentUser = JSON.parse(storedUser);
                document.getElementById('loginSection').classList.add('hidden');
                const dashboardId = currentUser.role + 'Dashboard';
                document.getElementById(dashboardId).classList.remove('hidden');
                
                if (currentUser.role === 'student') loadStudentDashboard();
                else if (currentUser.role === 'faculty') loadFacultyDashboard();
                else if (currentUser.role === 'admin') loadAdminDashboard();
            }
        });
    </script>
</body>
</html>
